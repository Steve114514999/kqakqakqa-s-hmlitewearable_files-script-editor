<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è„šæœ¬ç¼–è¾‘å™¨ - æœ¬åœ°æµ‹è¯•è¿è¡Œ</title>
    <style>
        :root {
            --bg-body: #f5f5f5;
            --bg-container: #ffffff;
            --bg-card: #f9f9f9;
            --bg-input: #ffffff;
            --bg-textarea: #f0f0f0;
            --bg-toggle-off: #ccc;
            --bg-toggle-on: #2196F3;
            --bg-log: #f8f9fa;
            --bg-log-success: #e8f5e9;
            --bg-log-error: #ffebee;
            --bg-log-info: #e3f2fd;

            --text-primary: #333333;
            --text-secondary: #555555;
            --text-light: #666666;
            --text-white: #ffffff;

            --border-color: #dddddd;
            --border-light: #eeeeee;

            --shadow-main: 0 2px 10px rgba(0,0,0,0.1);

            --btn-primary: #2196F3;
            --btn-success: #4CAF50;
            --btn-warning: #FF9800;
            --btn-danger: #ff4444;
            --btn-run: #00BCD4;
            --btn-stop: #FF5722;

            --transition-speed: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        
        body {
            padding: 20px;
            background: var(--bg-body);
            color: var(--text-primary);
        }
        
        .editor-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-container);
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow-main);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: var(--text-primary);
        }

        /* æ·±è‰²æ¨¡å¼å¼€å…³ */
        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }
        .mode-toggle input { display: none; }
        .toggle-slider {
            position: relative;
            width: 48px;
            height: 24px;
            background: #ccc;
            border-radius: 24px;
            transition: 0.3s;
        }
        .toggle-slider::before {
            content: '';
            position: absolute;
            top: 3px; left: 3px;
            width: 18px; height: 18px;
            border-radius: 50%;
            background: #fff;
            transition: 0.3s;
        }
        .mode-toggle input:checked + .toggle-slider {
            background: #2196F3;
        }
        .mode-toggle input:checked + .toggle-slider::before {
            transform: translateX(24px);
        }

        .form-group { margin-bottom: 20px; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
        }
        textarea { min-height: 80px; resize: vertical; }

        .steps-container {
            margin: 30px 0;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 20px;
        }
        .steps-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .step-item {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--bg-card);
        }
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-light);
        }
        .step-title { font-weight: 600; }
        .step-actions button {
            margin-left: 5px;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }
        .btn-delete { background: var(--btn-danger); color: #fff; }
        .btn-up, .btn-down { background: #666; color: #fff; }

        .param-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .param-item input { flex: 1; min-width: 120px; }

        .btn-add-step,
        .btn-generate,
        .btn-download,
        .btn-run,
        .btn-stop {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-add-step,
        .btn-generate { background: var(--btn-primary); }
        .btn-download { background: #009688; }
        .btn-run { background: var(--btn-run); }
        .btn-stop { background: var(--btn-stop); display: none; }

        .btn-add-param {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: var(--btn-success);
            color: #fff;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-load {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            background: var(--btn-warning);
            color: #fff;
            cursor: pointer;
        }
        .btn-toggle-mode {
            margin-top: 10px;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background: #78909C;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-remove-param {
            background: var(--btn-danger);
            color: #fff;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .download-options {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .download-options input { width: auto; }

        .json-preview { margin-top: 30px; }
        .json-preview textarea {
            font-family: Consolas, monospace;
            background: var(--bg-textarea);
            min-height: 200px;
        }

        /* æµ‹è¯•è¿è¡ŒåŒºåŸŸ */
        .run-controls {
            margin: 20px 0;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .run-buttons { display: flex; gap: 10px; }

        /* æ—¥å¿— */
        .run-logs { margin-top: 30px; }
        .logs-container {
            background: var(--bg-log);
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: Consolas, monospace;
            font-size: 13px;
        }
        .log-item {
            margin-bottom: 8px;
            padding: 6px 8px;
            border-radius: 3px;
            line-height: 1.4;
        }
        .log-item.info { background: var(--bg-log-info); color: #1565c0; }
        .log-item.success { background: var(--bg-log-success); color: #2e7d32; }
        .log-item.error { background: var(--bg-log-error); color: #c62828; }
        .log-time { font-weight: 600; margin-right: 8px; }
        .clear-logs {
            margin-top: 10px;
            padding: 6px 12px;
            background: #78909C;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .friendly-form {
            margin-top: 10px;
            padding: 15px;
            background: rgba(33,150,243,0.05);
            border-radius: 6px;
            border: 1px solid rgba(33,150,243,0.2);
        }
        .advanced-params-container,
        .advanced-controls { display: none; margin-top: 10px; }
        .custom-command-input { margin-top: 10px; display: none; }
        
        /* æ–°å¢é“¾æ¥åŒºåŸŸæ ·å¼ */
        .links-section {
            margin-top: 40px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .links-section a {
            color: #2196F3;
            text-decoration: none;
            font-size: 14px;
        }
        .links-section a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<div class="editor-container">
    <div class="header-top">
        <h1>è„šæœ¬ç¼–è¾‘å™¨ - æœ¬åœ°æµ‹è¯•è¿è¡Œ</h1>
        <label class="mode-toggle">
            <input type="checkbox" id="dark-mode-toggle">
            <span class="toggle-slider"></span>
            <span>æ·±è‰²æ¨¡å¼</span>
        </label>
    </div>

    <div class="form-group">
        <label>è„šæœ¬æè¿°</label>
        <input type="text" id="description" value="æµ‹è¯•è„šæœ¬">
    </div>

    <div class="steps-container">
        <div class="steps-header">
            <h3>æ‰§è¡Œæ­¥éª¤</h3>
            <div>
                <button class="btn-add-step" onclick="addStep()">æ·»åŠ æ­¥éª¤</button>
                <button class="btn-load" onclick="loadSampleData()">åŠ è½½ç¤ºä¾‹</button>
            </div>
        </div>
        <div id="steps-list"></div>
    </div>

    <!-- çº¯æœ¬åœ°æµ‹è¯•è¿è¡Œ -->
    <div class="run-controls">
        <div>æœ¬åœ°æµ‹è¯•è¿è¡Œï¼ˆä»…æ¨¡æ‹Ÿï¼Œä¸è¿æ¥è®¾å¤‡ï¼‰</div>
        <div class="run-buttons">
            <button class="btn-run" id="btn-run" onclick="startTestRun()">æµ‹è¯•è¿è¡Œ</button>
            <button class="btn-stop" id="btn-stop" onclick="stopTestRun()">åœæ­¢</button>
        </div>
    </div>

    <div class="actions">
        <button class="btn-generate" onclick="generateJSON()">ç”Ÿæˆ JSON</button>
        <button class="btn-download" onclick="downloadJSON()">ä¸‹è½½</button>
        <div class="download-options">
            <input type="checkbox" id="is-mp3" checked>
            <label>åŠ  .mp3 åç¼€</label>
        </div>
    </div>

    <div class="json-preview">
        <label>JSON é¢„è§ˆ</label>
        <textarea id="json-output"></textarea>
    </div>

    <div class="run-logs">
        <label>è¿è¡Œæ—¥å¿—</label>
        <div class="logs-container" id="logs-container"></div>
        <button class="clear-logs" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

<div style="margin-top: 30px; padding: 16px 20px; background:#f7f8fa; border-radius:10px; text-align:center; font-size:15px; line-height:1.8;">
    <a href="https://qm.qq.com/q/leKcIv1v10" target="_blank" 
       style="color:#1677ff; text-decoration:none; font-weight:500;">
        ğŸ‘‰ ç‚¹å‡»åŠ å…¥ç¾¤èŠã€åä¸ºé¸¿è’™æ‰‹è¡¨äº¤æµäºŒç¾¤ã€‘
    </a>
    <br>
    <span style="color:#666;">é å¢™çš„é’´-60 kqakqakqa æ–‡ä»¶ä»“åº“ï¼š</span>
    <a href="https://github.com/kqakqakqa/hmlitewearable_files" target="_blank" 
       style="color:#1677ff; text-decoration:none; font-weight:500;">
        GitHub
    </a>
</div>

<script>
let stepCounter = 0;
let isRunning = false;
let runTimer = null;
let currentStep = 0;
let scriptSteps = [];

const presetCommands = [
    { value: "", text: "è¯·é€‰æ‹©æŒ‡ä»¤" },
    { value: "console.log", text: "æ§åˆ¶å°è¾“å‡º" },
    { value: "file.mkdir", text: "åˆ›å»ºç›®å½•" },
    { value: "file.writeText", text: "å†™å…¥æ–‡æœ¬" },
    { value: "file.writeArrayBuffer", text: "å†™å…¥äºŒè¿›åˆ¶" },
    { value: "file.copy", text: "å¤åˆ¶æ–‡ä»¶" },
    { value: "file.move", text: "ç§»åŠ¨æ–‡ä»¶" },
    { value: "file.delete", text: "åˆ é™¤æ–‡ä»¶" },
    { value: "file.rmdir", text: "åˆ é™¤ç›®å½•" },
    { value: "custom", text: "è‡ªå®šä¹‰æŒ‡ä»¤" }
];

const friendlyFormConfigs = {
    "console.log": {
        fields: [{ key: "message", label: "è¾“å‡ºå†…å®¹", type: "text" }],
        getParams: v => v.message || "",
        parseParams: p => ({ message: p })
    },
    "file.mkdir": {
        fields: [
            { key: "uri", label: "ç›®å½•è·¯å¾„", type: "text" },
            { key: "recursive", label: "é€’å½’åˆ›å»º", type: "checkbox", default: true }
        ],
        getParams: v => ({ uri: v.uri||"", recursive: v.recursive }),
        parseParams: p => ({ uri: p.uri||"", recursive: p.recursive })
    },
    "file.writeText": {
        fields: [
            { key: "uri", label: "æ–‡ä»¶è·¯å¾„", type: "text" },
            { key: "text", label: "å†…å®¹", type: "textarea" },
            { key: "append", label: "è¿½åŠ æ¨¡å¼", type: "checkbox" }
        ],
        getParams: v => ({ uri: v.uri||"", text: v.text||"", append: v.append }),
        parseParams: p => ({ uri: p.uri||"", text: p.text||"", append: p.append })
    },
    "file.writeArrayBuffer": {
        fields: [
            { key: "uri", label: "æ–‡ä»¶è·¯å¾„", type: "text" },
            { key: "buffer", label: "æ•°æ®", type: "text" },
            { key: "append", label: "è¿½åŠ ", type: "checkbox" }
        ],
        getParams: v => {
            let buf = v.buffer||"[]";
            try { buf = JSON.parse(buf); } catch {}
            return { uri: v.uri||"", buffer: buf, append: v.append };
        },
        parseParams: p => ({ uri: p.uri||"", buffer: JSON.stringify(p.buffer||[]), append: p.append })
    },
    "file.copy": {
        fields: [
            { key: "srcUri", label: "æºè·¯å¾„", type: "text" },
            { key: "dstUri", label: "ç›®æ ‡è·¯å¾„", type: "text" }
        ],
        getParams: v => ({ srcUri: v.srcUri||"", dstUri: v.dstUri||"" }),
        parseParams: p => ({ srcUri: p.srcUri||"", dstUri: p.dstUri||"" })
    },
    "file.move": {
        fields: [
            { key: "srcUri", label: "æºè·¯å¾„", type: "text" },
            { key: "dstUri", label: "ç›®æ ‡è·¯å¾„", type: "text" }
        ],
        getParams: v => ({ srcUri: v.srcUri||"", dstUri: v.dstUri||"" }),
        parseParams: p => ({ srcUri: p.srcUri||"", dstUri: p.dstUri||"" })
    },
    "file.delete": {
        fields: [{ key: "uri", label: "æ–‡ä»¶è·¯å¾„", type: "text" }],
        getParams: v => ({ uri: v.uri||"" }),
        parseParams: p => ({ uri: p.uri||"" })
    },
    "file.rmdir": {
        fields: [
            { key: "uri", label: "ç›®å½•è·¯å¾„", type: "text" },
            { key: "recursive", label: "é€’å½’åˆ é™¤", type: "checkbox", default: true }
        ],
        getParams: v => ({ uri: v.uri||"", recursive: v.recursive }),
        parseParams: p => ({ uri: p.uri||"", recursive: p.recursive })
    }
};

// æ—¥å¿—
function addLog(type, msg) {
    const box = document.getElementById('logs-container');
    const time = new Date().toLocaleTimeString();
    const div = document.createElement('div');
    div.className = `log-item ${type}`;
    div.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}
function clearLogs() {
    document.getElementById('logs-container').innerHTML = '';
    addLog('info', 'æ—¥å¿—å·²æ¸…ç©º');
}

// æ­¥éª¤
function addStep(call='', params={}) {
    const list = document.getElementById('steps-list');
    const id = `step-${stepCounter++}`;
    const item = document.createElement('div');
    item.className = 'step-item';
    item.id = id;

    let select = `<select class="command-select" id="cmd-${id}" onchange="onCmdChange('${id}',this.value)">`;
    presetCommands.forEach(c => {
        select += `<option value="${c.value}" ${c.value==call?'selected':''}>${c.text}</option>`;
    });
    select += `</select>`;

    const customShow = call && !presetCommands.some(x=>x.value==call) ? 'block':'none';
    const customVal = call && !presetCommands.some(x=>x.value==call) ? call : '';

    item.innerHTML = `
    <div class="step-header">
        <div class="step-title">æ­¥éª¤ ${stepCounter}</div>
        <div class="step-actions">
            <button class="btn-up" onclick="moveUp('${id}')">ä¸Šç§»</button>
            <button class="btn-down" onclick="moveDown('${id}')">ä¸‹ç§»</button>
            <button class="btn-delete" onclick="delStep('${id}')">åˆ é™¤</button>
        </div>
    </div>
    <div class="form-group">
        <label>è°ƒç”¨æ–¹æ³•</label>
        ${select}
        <input type="text" class="custom-command-input" id="custom-${id}" 
            placeholder="è‡ªå®šä¹‰æŒ‡ä»¤" value="${customVal}" style="display:${customShow}">
    </div>
    <div class="form-group" id="params-group-${id}" style="display:none">
        <label>å‚æ•°</label>
        <div id="friendly-${id}" class="friendly-container"></div>
        <div id="advanced-${id}" class="advanced-params-container"></div>
        <div id="mode-toggle-${id}"></div>
        <div id="adv-controls-${id}" class="advanced-controls">
            <select id="param-type-${id}" onchange="changeParamType('${id}',this.value)">
                <option value="simple">ç®€å•å€¼</option>
                <option value="object">å¯¹è±¡</option>
            </select>
            <button class="btn-add-param" onclick="addParam('${id}')">æ·»åŠ å‚æ•°</button>
        </div>
    </div>`;

    list.appendChild(item);
    if (call && !presetCommands.some(x=>x.value==call)) {
        document.getElementById(`cmd-${id}`).value = 'custom';
    }
    initStepParams(id, call, params);
}

function initStepParams(id, call, params) {
    const cmd = call || document.getElementById(`cmd-${id}`).value;
    const group = document.getElementById(`params-group-${id}`);
    if (!cmd) {
        group.style.display = 'none';
        return;
    }
    group.style.display = 'block';

    if (friendlyFormConfigs[cmd]) {
        const vals = friendlyFormConfigs[cmd].parseParams(params);
        renderFriendly(id, cmd, vals);
        document.getElementById(`mode-toggle-${id}`).innerHTML = 
            `<button class="btn-toggle-mode" onclick="toggleMode('${id}',true)">é«˜çº§æ¨¡å¼</button>`;
    } else {
        document.getElementById(`adv-controls-${id}`).style.display = 'block';
        document.getElementById(`advanced-${id}`).style.display = 'block';
        renderAdvanced(id, params);
    }
}

function onCmdChange(id, cmd) {
    const custom = document.getElementById(`custom-${id}`);
    const group = document.getElementById(`params-group-${id}`);
    const friendly = document.getElementById(`friendly-${id}`);
    const advanced = document.getElementById(`advanced-${id}`);
    const advCtrl = document.getElementById(`adv-controls-${id}`);
    const modeToggle = document.getElementById(`mode-toggle-${id}`);

    if (!cmd) {
        custom.style.display = 'none';
        group.style.display = 'none';
        friendly.innerHTML = '';
        advanced.innerHTML = '';
        advCtrl.style.display = 'none';
        modeToggle.innerHTML = '';
        return;
    }

    group.style.display = 'block';
    custom.style.display = cmd === 'custom' ? 'block' : 'none';
    friendly.innerHTML = '';
    advanced.innerHTML = '';
    advCtrl.style.display = 'none';
    modeToggle.innerHTML = '';

    if (friendlyFormConfigs[cmd]) {
        renderFriendly(id, cmd);
        modeToggle.innerHTML = `<button class="btn-toggle-mode" onclick="toggleMode('${id}',true)">é«˜çº§æ¨¡å¼</button>`;
    } else {
        advCtrl.style.display = 'block';
        advanced.style.display = 'block';
        changeParamType(id, 'simple');
    }
}

function toggleMode(id, toAdv) {
    const friendly = document.getElementById(`friendly-${id}`);
    const advanced = document.getElementById(`advanced-${id}`);
    const advCtrl = document.getElementById(`adv-controls-${id}`);
    const toggle = document.getElementById(`mode-toggle-${id}`);
    const cmd = document.getElementById(`cmd-${id}`).value;
    const cfg = friendlyFormConfigs[cmd];

    if (toAdv) {
        friendly.style.display = 'none';
        advanced.style.display = 'block';
        advCtrl.style.display = 'block';
        toggle.innerHTML = `<button class="btn-toggle-mode" onclick="toggleMode('${id}',false)">ç®€å•æ¨¡å¼</button>`;
        if (cfg) {
            const vals = getFriendlyValues(id, cmd);
            renderAdvanced(id, cfg.getParams(vals));
        }
    } else {
        advanced.style.display = 'none';
        advCtrl.style.display = 'none';
        friendly.style.display = 'block';
        toggle.innerHTML = `<button class="btn-toggle-mode" onclick="toggleMode('${id}',true)">é«˜çº§æ¨¡å¼</button>`;
        if (cfg) {
            const p = getAdvancedParams(id);
            renderFriendly(id, cmd, cfg.parseParams(p));
        }
    }
}

function renderFriendly(id, cmd, init={}) {
    const cfg = friendlyFormConfigs[cmd];
    if (!cfg) return;
    const box = document.getElementById(`friendly-${id}`);
    box.innerHTML = '';
    const form = document.createElement('div');
    form.className = 'friendly-form';
    form.id = `ff-${id}`;

    cfg.fields.forEach(f => {
        const val = init[f.key] ?? f.default ?? '';
        const fid = `ff-${id}-${f.key}`;
        let html = `<div class="form-group"><label>${f.label}</label>`;
        if (f.type === 'textarea') {
            html += `<textarea id="${fid}" data-key="${f.key}">${val}</textarea>`;
        } else if (f.type === 'checkbox') {
            html += `<input type="checkbox" id="${fid}" data-key="${f.key}" ${val?'checked':''}>`;
        } else {
            html += `<input type="text" id="${fid}" data-key="${f.key}" value="${val}">`;
        }
        html += `</div>`;
        form.innerHTML += html;
    });
    box.appendChild(form);
}

function renderAdvanced(id, params) {
    const box = document.getElementById(`advanced-${id}`);
    box.innerHTML = '';
    if (typeof params === 'object' && params !== null && !Array.isArray(params)) {
        document.getElementById(`param-type-${id}`).value = 'object';
        Object.entries(params).forEach(([k, v]) => addAdvParam(id, k, v));
    } else {
        document.getElementById(`param-type-${id}`).value = 'simple';
        box.innerHTML = `<input type="text" class="param-simple" value="${params||''}">`;
    }
}

function getFriendlyValues(id, cmd) {
    const cfg = friendlyFormConfigs[cmd];
    if (!cfg) return {};
    const vals = {};
    cfg.fields.forEach(f => {
        const el = document.getElementById(`ff-${id}-${f.key}`);
        if (el) vals[f.key] = f.type === 'checkbox' ? el.checked : el.value;
    });
    return vals;
}

function getAdvancedParams(id) {
    const t = document.getElementById(`param-type-${id}`).value;
    const box = document.getElementById(`advanced-${id}`);
    if (t === 'simple') {
        const i = box.querySelector('.param-simple');
        return i ? parse(i.value) : '';
    } else {
        const o = {};
        box.querySelectorAll('.param-item').forEach(p => {
            const k = p.querySelector('.param-key')?.value;
            const v = p.querySelector('.param-value')?.value;
            if (k) o[k] = parse(v||'');
        });
        return o;
    }
}

function addParam(id) {
    const t = document.getElementById(`param-type-${id}`).value;
    const box = document.getElementById(`advanced-${id}`);
    if (t === 'simple') box.innerHTML = `<input type="text" class="param-simple">`;
    else addAdvParam(id, '', '');
}
function addAdvParam(id, k, v) {
    const box = document.getElementById(`advanced-${id}`);
    const pid = `p-${id}-${box.children.length}`;
    const div = document.createElement('div');
    div.className = 'param-item';
    div.id = pid;
    div.innerHTML = `
        <input class="param-key" value="${k}" placeholder="é”®">
        <input class="param-value" value="${v}" placeholder="å€¼">
        <button class="btn-remove-param" onclick="delParam('${pid}')">åˆ </button>`;
    box.appendChild(div);
}
function changeParamType(id, t) {
    document.getElementById(`advanced-${id}`).innerHTML = '';
    addParam(id);
}
function delParam(id) { document.getElementById(id)?.remove(); }

function moveUp(id) {
    const el = document.getElementById(id);
    const prev = el.previousElementSibling;
    if (prev) el.parentElement.insertBefore(el, prev);
    renumber();
}
function moveDown(id) {
    const el = document.getElementById(id);
    const next = el.nextElementSibling;
    if (next) el.parentElement.insertBefore(next, el);
    renumber();
}
function renumber() {
    document.querySelectorAll('.step-item').forEach((s,i)=>{
        s.querySelector('.step-title').textContent = `æ­¥éª¤ ${i+1}`;
    });
}
function delStep(id) {
    document.getElementById(id)?.remove();
    renumber();
}

function parse(v) {
    if (v === '') return '';
    if (!isNaN(Number(v))) return Number(v);
    if (v.toLowerCase() === 'true') return true;
    if (v.toLowerCase() === 'false') return false;
    try { return JSON.parse(v); } catch {}
    return v;
}

// JSON
function generateJSON() {
    try {
        const obj = {
            description: document.getElementById('description').value,
            steps: []
        };
        document.querySelectorAll('.step-item').forEach(s => {
            const id = s.id;
            let cmd = document.getElementById(`cmd-${id}`).value;
            if (cmd === 'custom') cmd = document.getElementById(`custom-${id}`).value.trim();
            if (!cmd) return;

            const isAdv = document.getElementById(`adv-controls-${id}`).style.display === 'block';
            const p = isAdv ? getAdvancedParams(id) : 
                (friendlyFormConfigs[cmd]?.getParams(getFriendlyValues(id, cmd)) || '');
            obj.steps.push({ call: cmd, params: p });
        });
        document.getElementById('json-output').value = JSON.stringify(obj, null, 2);
        addLog('info', 'JSON å·²ç”Ÿæˆ');
    } catch (e) {
        addLog('error', 'ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
    }
}

function downloadJSON() {
    const c = document.getElementById('json-output').value.trim();
    if (!c) { addLog('error','æ— å†…å®¹'); return; }
    let name = (document.getElementById('description').value || 'script').replace(/[\\/:*?"<>|]/g,'_') + '.json';
    if (document.getElementById('is-mp3').checked) name += '.mp3';
    const blob = new Blob([c], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
    addLog('success', 'å·²ä¸‹è½½ï¼š' + name);
}

function loadSampleData() {
    document.getElementById('steps-list').innerHTML = '';
    stepCounter = 0;
    document.getElementById('description').value = 'æµ‹è¯•ç¤ºä¾‹';
    const steps = [
        { call: 'console.log', params: 'å¼€å§‹æµ‹è¯•' },
        { call: 'file.mkdir', params: { uri: 'internal://test', recursive: true } },
        { call: 'file.writeText', params: { uri: 'internal://test/hello.txt', text: 'test', append: false } }
    ];
    steps.forEach(s => addStep(s.call, s.params));
    generateJSON();
    addLog('success', 'ç¤ºä¾‹å·²åŠ è½½');
}

// ======================
// çº¯æœ¬åœ°æµ‹è¯•è¿è¡Œï¼ˆæ ¸å¿ƒï¼‰
// ======================
function startTestRun() {
    if (isRunning) return;
    const json = document.getElementById('json-output').value.trim();
    if (!json) { addLog('error','å…ˆç”ŸæˆJSON'); return; }

    try {
        const data = JSON.parse(json);
        if (!data.steps || !data.steps.length) {
            addLog('error','æ²¡æœ‰æ­¥éª¤');
            return;
        }
        isRunning = true;
        currentStep = 0;
        scriptSteps = data.steps;
        document.getElementById('btn-run').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'block';
        addLog('info', `å¼€å§‹æµ‹è¯•è¿è¡Œï¼š${data.description || 'è„šæœ¬'}`);
        runNextTestStep();
    } catch (e) {
        addLog('error','è§£æå¤±è´¥ï¼š' + e.message);
    }
}

function stopTestRun() {
    if (runTimer) clearTimeout(runTimer);
    isRunning = false;
    document.getElementById('btn-run').style.display = 'block';
    document.getElementById('btn-stop').style.display = 'none';
    addLog('info', 'æµ‹è¯•å·²åœæ­¢');
}

function runNextTestStep() {
    if (!isRunning || currentStep >= scriptSteps.length) {
        stopTestRun();
        addLog('success', 'æµ‹è¯•è¿è¡Œå®Œæˆï¼');
        return;
    }

    const step = scriptSteps[currentStep];
    const idx = currentStep + 1;
    addLog('info', `æµ‹è¯•æ­¥éª¤ ${idx}/${scriptSteps.length}ï¼š${step.call}`);

    // çº¯æœ¬åœ°æ¨¡æ‹Ÿæ‰§è¡Œ
    testRunCommand(step.call, step.params);

    addLog('success', `æ­¥éª¤ ${idx} æ¨¡æ‹Ÿæ‰§è¡Œå®Œæˆ`);
    currentStep++;
    runTimer = setTimeout(runNextTestStep, 700);
}

function testRunCommand(cmd, params) {
    // åªåœ¨æµè§ˆå™¨é‡Œæ¨¡æ‹Ÿæ‰“å°ï¼Œä¸è°ƒç”¨ä»»ä½•è®¾å¤‡
    switch (cmd) {
        case 'console.log':
            addLog('info', `æ¨¡æ‹Ÿè¾“å‡ºï¼š${params}`);
            break;
        case 'file.mkdir':
            addLog('info', `æ¨¡æ‹Ÿåˆ›å»ºç›®å½•ï¼š${params?.uri}`);
            break;
        case 'file.writeText':
            addLog('info', `æ¨¡æ‹Ÿå†™å…¥æ–‡ä»¶ï¼š${params?.uri}`);
            break;
        case 'file.writeArrayBuffer':
            addLog('info', `æ¨¡æ‹Ÿå†™å…¥äºŒè¿›åˆ¶ï¼š${params?.uri}`);
            break;
        case 'file.copy':
            addLog('info', `æ¨¡æ‹Ÿå¤åˆ¶ï¼š${params?.srcUri} â†’ ${params?.dstUri}`);
            break;
        case 'file.move':
            addLog('info', `æ¨¡æ‹Ÿç§»åŠ¨ï¼š${params?.srcUri} â†’ ${params?.dstUri}`);
            break;
        case 'file.delete':
            addLog('info', `æ¨¡æ‹Ÿåˆ é™¤ï¼š${params?.uri}`);
            break;
        case 'file.rmdir':
            addLog('info', `æ¨¡æ‹Ÿåˆ é™¤ç›®å½•ï¼š${params?.uri}`);
            break;
        default:
            addLog('info', `æ¨¡æ‹Ÿè‡ªå®šä¹‰æŒ‡ä»¤ï¼š${cmd}ï¼Œå‚æ•°ï¼š${JSON.stringify(params)}`);
    }
}

window.onload = () => {
    addStep();
    addLog('info', 'ç¼–è¾‘å™¨å·²å°±ç»ªï¼ˆæœ¬åœ°æµ‹è¯•ç‰ˆï¼‰');
};
</script>
</body>
</html>